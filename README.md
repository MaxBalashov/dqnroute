## Introduction

This project enhances [dqnroute](https://github.com/flyingleafe/dqnroute) in several ways.
The modifications concern only the baggage handling capabilities of the original project.

Original citation: [Mukhutdinov, D., Filchenkov, A., Shalyto, A., & Vyatkin, V. (2019). Multi-agent deep learning for simultaneous optimization for time and energy in distributed routing system. Future Generation Computer Systems, 94, 587-600](https://www.sciencedirect.com/science/article/pii/S0167739X18309087?casa_token=3O7gKwF4KRAAAAAA:Ia9qKHkdtgvekRjrCL_M7U5jBFpIYCVPMUagJTf88lWfjJrv6D7zNkaJyYIPj9mculdSsbLXYhI). Note that the use of graph embeddings is not yet reported there.

## Changes w.r.t. the original dqnroute

* Neural network verification methods (work in progress).
* The decisions of the neural network are altered to exclude routing probabilities that are very close to 0 and 1. This is done similarly to label smoothing.
* A [script](/src/Verify.py) that offers an easier access to the original project by performing both pretraining and training. It also visualizes topology graphs.
* [Examples](/launches/igor) of baggage handling topology graphs, in particular with cycles:
	* [Example](/launches/igor/tarau2010.yaml) (and [visualization](/launches/igor/ConveyorGraph-Tarau2010.pdf)) based on [Tarau, Alina N., Bart De Schutter, and Hans Hellendoorn. "Model-based control for route choice in automated baggage handling systems." IEEE Transactions on Systems, Man, and Cybernetics, Part C (Applications and Reviews) 40.3 (2010): 341-351]
	* [Example](/launches/igor/johnstone2010.yaml) (and [visualization](/launches/igor/ConveyorGraph-Johnstone2010.pdf)) based on [Johnstone, Michael, Doug Creighton, and Saeid Nahavandi. "Status-based routing in baggage handling systems: Searching verses learning." IEEE Transactions on Systems, Man, and Cybernetics, Part C (Applications and Reviews) 40.2 (2009): 189-200]
* A fix (?) for the bug: a bag was processed incorrectly if it passed twice along the same conveyor. This is possible only in topology graphs with cycles.

Unfortunately, some features are currently implemented with global variables due to Igor's lack of good understanding of the simulation model.

## Dependencies

The file [requirements.txt](/requirements.txt) is not up-to-date. Just install whatever is missing. You will at least need to have the following packages: torch, sympy, pygraphviz.

## Running

Option 1: run an all-in-one verification script [Verify.py](/src/Verify.py). In particular, it contains the "compare" command, which runs simulations without any verification. This command will create delivery time and energy consumption plots. Some examples are given in [VerifyWrapper.py](/src/VerifyWrapper.py). Run the scripts from the "src" directory, e.g.:
```console
  cd src
  ipython VerifyWrapper.py
```

Option 2: run notebooks: [new_pretrain.ipynb](/notebooks/new_pretrain.ipynb), then [new_train.ipynb](/notebooks/new_train.ipynb). Running new_train.ipynb requires having a pretrained model generated by new_pretrain.ipynb for the same topology graph and embedding dimension (see scenario, emb_dim, graph_size = ... assignments). Unfortunately, the graph size needs to be entered manually. It is equal to the total number of sources, junctions, diverters and sinks.